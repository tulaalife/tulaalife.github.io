// Node ESM build-time script
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { createClient } from '@supabase/supabase-js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ---- Config
const TABLES = {
    plans: 'plans',
    plan_translations: 'plan_translations',
    audios: 'guided_audio_sessions',
    tips: 'health_tips',
    posts: 'posts',
};
const N_TIPS = 10; // homepage slice size

const { PREVIEW_VISIBILITIES = 'public' } = process.env;
const ALLOWED_VIS = PREVIEW_VISIBILITIES.split(',').map(s => s.trim()).filter(Boolean);

// ---- Helpers
const teaser = (s, max = 160) => {
    if (!s) return '';
    const t = String(s).replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    if (t.length <= max) return t;
    const cut = t.slice(0, max + 1);
    const idx = cut.lastIndexOf(' ');
    return (idx > 0 ? cut.slice(0, idx) : cut.slice(0, max)).trim() + '…';
};

const toAbs = (s) => (s ?? '').toString().trim();
const ensureHttps = (u) => (u && /^https?:\/\//i.test(u) ? u : '');

// Helper to process JSONB insights into a string
const formatBenefits = (insightsJson) => {
    let benefits = '';
    try {
        if (Array.isArray(insightsJson)) {
            const parts = insightsJson.map((it) =>
                typeof it === 'string' ? it : (it?.text ?? it?.title ?? it?.value ?? '')
            ).filter(Boolean);
            benefits = parts.join(' · ').slice(0, 240);
        }
    } catch { }
    return benefits;
};

const outBanner = (ts) => `// AUTO-GENERATED FILE. DO NOT EDIT.
// Generated by scripts/fetch-content.mjs during CI.
// This file is intentionally not committed.
${ts}
`;

// Deterministic daily shuffle
const seededShuffle = (arr, seed) => {
    const a = arr.slice();
    let x = seed || 1;
    const rand = () => {
        x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
        return (x >>> 0) / 0xffffffff;
    };
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rand() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
};

// ---- Supabase client
const { SUPABASE_URL, SUPABASE_SERVICE_KEY } = process.env;
if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    console.error('[fetch-content] Missing SUPABASE_URL / SUPABASE_SERVICE_KEY in env');
    process.exit(1);
}
const sb = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, { auth: { persistSession: false } });

// ---- Loads

async function loadPlans() {
    // 1. Fetch Plans AND their Translations
    const { data, error } = await sb
        .from(TABLES.plans)
        .select(`
            slug, title, subtitle, description, insights, image_url, visibility,
            plan_translations (
                lang, title, subtitle, description, insights
            )
        `)
        .in('visibility', ALLOWED_VIS)
        .not('slug', 'is', null)
        .order('title', { ascending: true });

    if (error) throw error;

    const results = [];

    (data ?? []).forEach((r) => {
        const baseSlug = toAbs(r.slug);
        const baseImage = ensureHttps(toAbs(r.image_url));

        if (!baseSlug || !baseImage) return;

        // 2. Add Base English Version
        results.push({
            slug: baseSlug,
            language: 'en',
            title: toAbs(r.title),
            subtitle: toAbs(r.subtitle),
            teaser: teaser(r.description),
            benefits: formatBenefits(r.insights),
            image: baseImage,
            deeplink: `tulaa://en/yoga/${baseSlug}`,
        });

        // 3. Add Translations (if any)
        if (Array.isArray(r.plan_translations)) {
            r.plan_translations.forEach((tr) => {
                // Ensure we have minimal required fields for a valid page
                if (!tr.title || !tr.lang) return;

                results.push({
                    slug: baseSlug, // Keeps same slug as English
                    language: tr.lang,
                    title: toAbs(tr.title),
                    subtitle: toAbs(tr.subtitle),
                    teaser: teaser(tr.description),
                    benefits: formatBenefits(tr.insights),
                    image: baseImage, // Fallback to base image
                    deeplink: `tulaa://${tr.lang}/yoga/${baseSlug}`,
                });
            });
        }
    });

    return results;
}

async function loadAudios() {
    const { data, error } = await sb
        .from(TABLES.audios)
        .select('slug, language, title, subtitle, description, image_url, updated_at')
        .not('slug', 'is', null)
        .not('image_url', 'is', null)
        .order('title', { ascending: true });

    if (error) throw error;

    return (data ?? []).map((r) => {
        const lang = r.language || 'en';
        return {
            slug: toAbs(r.slug),
            language: lang,
            title: toAbs(r.title),
            subtitle: teaser(r.subtitle),
            teaser: teaser(r.description),
            image: ensureHttps(toAbs(r.image_url)),
            deeplink: `tulaa://audio/${toAbs(r.slug)}`,
        };
    }).filter(a => a.slug && a.image);
}

async function loadAllTips() {
    const { data, error } = await sb
        .from(TABLES.tips)
        .select('slug,tip,benefit,precaution,category,icon,updated_at')
        .not('slug', 'is', null)
        .order('slug', { ascending: true });

    if (error) throw error;

    return (data ?? []).map((r) => ({
        slug: toAbs(r.slug),
        tip: toAbs(r.tip),
        benefit: toAbs(r.benefit),
        precaution: toAbs(r.precaution),
        category: toAbs(r.category),
        icon: toAbs(r.icon),
        deeplink: `tulaa://app/tips/${toAbs(r.slug)}`,
    })).filter(t => t.slug && t.tip && t.benefit);
}

async function loadPosts() {
    const { data, error } = await sb
        .from(TABLES.posts)
        .select(`
            slug, title, excerpt, cover_image_url, 
            status, published_at, language, 
            seo_title, seo_description, 
            content, goal_ids, suitable_time_of_day,
            cta_link, cta_text
        `)
        .eq('status', 'published')
        .not('slug', 'is', null)
        .order('published_at', { ascending: false });

    if (error) throw error;

    return (data ?? []).map((r) => {
        const metaTitle = r.seo_title || r.title;
        const metaDesc = r.seo_description || r.excerpt || '';

        return {
            slug: toAbs(r.slug),
            language: r.language || 'en',
            title: toAbs(r.title),
            excerpt: toAbs(r.excerpt),
            image: ensureHttps(toAbs(r.cover_image_url)),
            date: r.published_at,
            metaTitle: toAbs(metaTitle),
            metaDescription: toAbs(metaDesc),
            content: r.content,
            cta: (r.cta_link && r.cta_text) ? { link: r.cta_link, text: r.cta_text } : null,
            goals: r.goal_ids || [],
            timeOfDay: r.suitable_time_of_day || [],
        };
    });
}

// ---- Emit
function toTsArray(varName, arr) {
    const json = JSON.stringify(arr, null, 2);
    return `export const ${varName} = ${json} as const;`;
}

async function run() {
    const [plans, audios, tipsAll, posts] = await Promise.all([
        loadPlans(),
        loadAudios(),
        loadAllTips(),
        loadPosts(),
    ]);

    const daySeed = Number(new Date().toISOString().slice(0, 10).replaceAll('-', ''));
    const tips = seededShuffle(tipsAll, daySeed).slice(0, N_TIPS);

    const ts = `import type { YogaPlanPreview, GuidedAudioPreview, TipPreview } from './types';

${toTsArray('yogaPlans', plans)}
${toTsArray('guidedAudios', audios)}
${toTsArray('tips', tips)}
${toTsArray('allTips', tipsAll)}
${toTsArray('blogPosts', posts)}
`;

    const outDir = path.join(__dirname, '..', 'src', 'data');
    fs.mkdirSync(outDir, { recursive: true });
    fs.writeFileSync(path.join(outDir, 'generated.ts'), outBanner(ts), 'utf8');

    console.log(
        `[fetch-content] Wrote src/data/generated.ts with ${plans.length} plans (across all langs), ${audios.length} audios, ${tipsAll.length} tips & ${posts.length} posts.`
    );
}

run().catch((e) => {
    console.error('[fetch-content] ERROR:', e);
    process.exit(1);
});