---
import CTAButton from "./CTAButton.astro";

export interface TipItem {
    tip: string;
    benefit?: string;
    icon?: string; // emoji or URL
}
export interface Props {
    title: string;
    subtitle?: string;
    items: TipItem[]; // ~5 recommended
    intervalMs?: number; // default 5200ms
    ctaHref?: string; // optional CTA (Explore tips)
    ctaLabel?: string;
}

const {
    title,
    subtitle,
    items = [],
    intervalMs = 5200,
    ctaHref,
    ctaLabel,
} = Astro.props;

const hasCTA = Boolean(ctaHref && ctaLabel);
---

{
    items.length > 0 && (
        <section
            class:list={["ts-wrap", "home-block"]}
            data-interval={String(intervalMs)}
            tabindex="0"
            role="region"
            aria-label={title}
        >
            <header class="ts-header">
                <h2 class="ts-title">{title}</h2>
                {subtitle && <p class="ts-subtitle">{subtitle}</p>}
            </header>

            <div class="ts-panel" aria-live="polite">
                <ul class="ts-track" role="list">
                    {items.map((t, idx) => (
                        <li
                            class="ts-slide"
                            aria-hidden={idx === 0 ? "false" : "true"}
                            data-active={idx === 0 ? "true" : "false"}
                        >
                            <div class="ts-card">
                                <div class="ts-icon" aria-hidden="true">
                                    {t.icon?.startsWith("http") ? (
                                        <img
                                            src={t.icon}
                                            alt=""
                                            loading="lazy"
                                            decoding="async"
                                        />
                                    ) : (
                                        <span>{t.icon ?? "üí°"}</span>
                                    )}
                                </div>
                                <div class="ts-body">
                                    <h3 class="ts-h3">{t.tip}</h3>
                                    {t.benefit && (
                                        <p class="ts-p">{t.benefit}</p>
                                    )}
                                </div>
                            </div>
                        </li>
                    ))}
                </ul>
            </div>

            {hasCTA && (
                <div class="ts-ctaRow">
                    <CTAButton
                        href={ctaHref!}
                        label={ctaLabel!}
                        icon="‚Üó"
                        variant="solid"
                        size="lg"
                    />
                </div>
            )}
        </section>
    )
}

<style>
    /* Root sits inside .home and reuses .home-block for the glossy shell */
    .ts-wrap {
        width: 100%;
        max-width: 100%; /* let <main> / parent container control rail width */
        /* margin: 36px auto 32px; */
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: clamp(12px, 2vw, 18px);
    }

    /* Heading */
    .ts-header {
        text-align: center;
    }
    .ts-title {
        font-size: var(--fs-h1);
        font-weight: var(--fw-semibold);
        margin: 0;
        letter-spacing: 0.01em;
    }
    .ts-subtitle {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: var(--fs-body-sm);
    }

    /* Inner panel ‚Äì now ‚Äúflat‚Äù so home-block provides main gloss */
    .ts-panel {
        --r: 18px;
        padding: 8px 4px;
        border-radius: var(--r);
        background: transparent;
        border: none;
        box-shadow: none;
    }

    /* Track */
    .ts-track {
        position: relative;
        padding: 0;
        margin: 0;
        list-style: none;
        height: var(--ts-h, auto);
        min-height: 112px;
    }

    /* Slide stack */
    .ts-slide {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: translateY(8px) scale(0.985);
        transition:
            opacity 0.45s ease,
            transform 0.45s ease;
    }
    .ts-slide[data-active="true"] {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    /* Icon + text block */
    .ts-card {
        width: 100%;
        max-width: 860px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 4px 0;
        background: transparent;
        border: none;
        box-shadow: none;
        border-radius: 18px;
        transition: transform 0.2s ease;
    }

    .ts-card:hover {
        transform: translateY(-1px);
    }

    /* Icon badge */
    .ts-icon {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        font-size: 28px;
        background: linear-gradient(
            180deg,
            color-mix(in oklch, var(--card), white 12%),
            color-mix(in oklch, var(--card), transparent 12%)
        );
        border: 1px solid color-mix(in oklch, var(--ring), transparent 28%);
        box-shadow:
            inset 0 2px 4px rgba(255, 255, 255, 0.65),
            0 6px 18px rgba(0, 0, 0, 0.08);
    }

    .ts-icon img {
        width: 30px;
        height: 30px;
        object-fit: contain;
    }

    /* Text */
    .ts-body {
        flex: 1;
    }
    .ts-h3 {
        margin: 0 0 6px;
        font-size: var(--fs-body);
        font-weight: var(--fw-semibold);
        line-height: 1.35;
    }
    .ts-p {
        margin: 0;
        font-size: var(--fs-body-sm);
        color: var(--muted);
        line-height: 1.55;
    }

    /* CTA */
    .ts-ctaRow {
        display: flex;
        justify-content: center;
        margin-top: clamp(12px, 2vw, 20px);
    }

    @media (max-width: 640px) {
        .ts-card {
            align-items: flex-start;
        }
        .ts-icon {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            font-size: 24px;
        }
    }
</style>

<script is:inline>
    (() => {
        function boot(root) {
            const track = root.querySelector(".ts-track");
            const slides = Array.from(root.querySelectorAll(".ts-slide"));
            if (!track || slides.length === 0) return;

            const setActive = (el, active) => {
                el.setAttribute("data-active", active ? "true" : "false");
                el.setAttribute("aria-hidden", active ? "false" : "true");
            };

            const adjustHeight = () => {
                const activeCard = root.querySelector(
                    '.ts-slide[data-active="true"] .ts-card',
                );
                if (!activeCard) return;
                track.style.setProperty(
                    "--ts-h",
                    activeCard.getBoundingClientRect().height + "px",
                );
            };

            slides.forEach((el, i) => setActive(el, i === 0));
            adjustHeight();

            if (slides.length <= 1) return;

            let idx = 0;
            const interval = Math.max(
                2400,
                Number(root.getAttribute("data-interval") || 5200),
            );
            let timer = null;
            let stopped = false; // stop autoplay after user interaction
            let hovered = false;

            const next = () => {
                const prev = slides[idx];
                idx = (idx + 1) % slides.length;
                const cur = slides[idx];
                setActive(prev, false);
                setActive(cur, true);
                adjustHeight();
            };

            const tick = () => {
                if (!hovered && !stopped) next();
            };

            const start = () => {
                stop();
                timer = setInterval(tick, interval);
            };

            const stop = () => {
                if (timer) clearInterval(timer);
                timer = null;
            };

            const stopForUser = () => {
                if (stopped) return;
                stopped = true;
                stop();
            };

            ["pointerdown", "touchstart", "wheel", "keydown"].forEach((ev) => {
                root.addEventListener(ev, stopForUser, { passive: true });
            });

            root.addEventListener("mouseenter", () => (hovered = true));
            root.addEventListener("mouseleave", () => (hovered = false));

            setTimeout(start, 200);
            window.addEventListener("resize", adjustHeight);
        }

        const init = () => document.querySelectorAll(".ts-wrap").forEach(boot);

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", init, { once: true });
        } else {
            init();
        }
    })();
</script>
