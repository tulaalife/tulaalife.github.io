---
import StoreButtons from "../StoreButtons.astro";

// 1. Get current language
const currentLang = Astro.currentLocale || "en";

// 2. Dictionary for Hero content
const ui = {
    en: {
        badge: "‚ú® 100% Free. Private. Offline.",
        titleTop: "Expert Yoga Therapy.",
        titleBottom: "No Ads. No Login.",
        author: "<strong>By Latika Bissa</strong>",
        cred1: "üèÖ Gold Medalist, M.Sc Yoga Therapy",
        cred2: "üßò‚Äç‚ôÄÔ∏è 10+ Years of Clinical Experience",
        subtitle:
            "Specialized plans for <strong>Back Pain, PCOS, Thyroid, and Prenatal care.</strong> Designed to help you heal, without tracking your data.",
    },
    hi: {
        badge: "‚ú® 100% ‡§´‡•ç‡§∞‡•Ä ‚Ä¢ ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§ü ‚Ä¢ ‡§ë‡§´‡§≤‡§æ‡§á‡§®",
        titleTop: "‡§è‡§ï‡•ç‡§∏‡§™‡§∞‡•ç‡§ü ‡§Ø‡•ã‡§ó ‡§•‡•á‡§∞‡•á‡§™‡•Ä",
        titleBottom: "‡§ï‡•ã‡§à ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§ï‡•ã‡§à ‡§≤‡•â‡§ó‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç‡•§",
        author: "<strong>‡§Ø‡•ã‡§ó ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§≤‡§§‡§ø‡§ï‡§æ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ</strong>",
        cred1: "üèÖ ‡§ó‡•ã‡§≤‡•ç‡§° ‡§Æ‡•á‡§°‡§≤‡§ø‡§∏‡•ç‡§ü, M.Sc ‡§Ø‡•ã‡§ó ‡§•‡•á‡§∞‡•á‡§™‡•Ä",
        cred2: "üßò‚Äç‚ôÄÔ∏è 10+ ‡§µ‡§∞‡•ç‡§∑‡•ã‡§Ç ‡§ï‡§æ ‡§ï‡•ç‡§≤‡§ø‡§®‡§ø‡§ï‡§≤ ‡§Ö‡§®‡•Å‡§≠‡§µ",
        subtitle:
            "<strong>‡§™‡•Ä‡§† ‡§¶‡§∞‡•ç‡§¶, PCOS, ‡§•‡§æ‡§Ø‡§∞‡•â‡§á‡§° ‡§î‡§∞ ‡§ó‡§∞‡•ç‡§≠‡§æ‡§µ‡§∏‡•ç‡§•‡§æ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤</strong> ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§Ø‡•ã‡§ó ‡§™‡•ç‡§≤‡§æ‡§®‡•§ ‡§â‡§™‡§ö‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∏‡§π‡§æ‡§Ø‡§ï, ‡§™‡•Ç‡§∞‡•Ä ‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§ï‡•á ‡§∏‡§æ‡§•‡•§",
    },
};

const t = ui[currentLang as keyof typeof ui] || ui.en;

// 3. Define the localized file paths
// Using the optimized Hindi files you just generated
const posterSrc = currentLang === "hi" ? "/poster-hindi.webp" : "/poster.webp";
const videoWebm =
    currentLang === "hi"
        ? "/website-app-demo-hindi.webm"
        : "/website-app-demo.webm";
const videoMp4 =
    currentLang === "hi"
        ? "/website-app-demo-hindi.mp4"
        : "/website-app-demo.mp4";
---

<link rel="preload" as="image" href={posterSrc} />

<section id="hero" class="hero-section">
    <div class="container hero-grid">
        <div class="hero-content" id="download-content">
            <div class="badge">{t.badge}</div>
            <h1 class="hero-title">
                {t.titleTop}
                <br />
                <span class="text-gradient">{t.titleBottom}</span>
            </h1>

            <div
                style="background: var(--bg-sub); padding: 12px 16px; border-radius: 12px; margin-bottom: 24px; display: inline-block; border: 1px solid var(--border);"
            >
                <p style="margin: 0; font-size: 0.95rem; line-height: 1.4;">
                    <Fragment set:html={t.author} /><br />
                    <span style="opacity: 0.8; font-size: 0.9rem;"
                        >{t.cred1}</span
                    ><br />
                    <span style="opacity: 0.8; font-size: 0.9rem;"
                        >{t.cred2}</span
                    >
                </p>
            </div>

            <p class="hero-sub" style="margin-top: 0;" set:html={t.subtitle} />

            <div class="cta-wrapper">
                <StoreButtons centered={false} />
            </div>
        </div>

        <div class="hero-visual">
            <div
                class="phone-frame-wrapper skeleton-loader"
                id="phoneWrapper"
                data-poster={posterSrc}
                data-webm={videoWebm}
                data-mp4={videoMp4}
            >
                <video
                    id="heroVideo"
                    class="app-video"
                    loop
                    muted
                    playsinline
                    preload="none"
                    width="300"
                    height="533"></video>
                <div class="glow-blob"></div>
            </div>
        </div>
    </div>
</section>

<script>
    // üëá NEW: Changed from DOMContentLoaded to astro:page-load
    document.addEventListener("astro:page-load", () => {
        const wrapper = document.getElementById("phoneWrapper");
        const video = document.getElementById("heroVideo") as HTMLVideoElement;

        if (!wrapper || !video) return;

        // üëá NEW: Clean up previous state if navigating via language toggle
        video.innerHTML = "";
        video.classList.remove("is-playing");

        // --- PART 1: Poster Loading (Dynamic) ---
        const posterSrc = wrapper.getAttribute("data-poster") || "/poster.webp";
        const img = new Image();
        img.src = posterSrc;

        const showPoster = () => {
            wrapper.classList.remove("skeleton-loader");
            wrapper.style.backgroundImage = `url('${img.src}')`;
            wrapper.classList.add("has-poster");
        };

        if (img.complete) {
            showPoster();
        } else {
            img.onload = showPoster;
            // Optional: fallback timeout if image hangs
            setTimeout(showPoster, 3000);
        }

        // --- PART 2: Video Loading (Dynamic) ---
        interface NetworkInformation {
            saveData?: boolean;
            effectiveType?: "slow-2g" | "2g" | "3g" | "4g";
        }
        interface ExtendedNavigator extends Navigator {
            connection?: NetworkInformation;
            mozConnection?: NetworkInformation;
            webkitConnection?: NetworkInformation;
        }

        const nav = navigator as ExtendedNavigator;
        const connection =
            nav.connection || nav.mozConnection || nav.webkitConnection;

        const isSlow =
            connection &&
            (connection.saveData ||
                ["slow-2g", "2g"].includes(connection.effectiveType || ""));

        if (isSlow) return;

        const initVideo = () => {
            const webmSrc = wrapper.getAttribute("data-webm");
            const mp4Src = wrapper.getAttribute("data-mp4");

            const sources = [
                { src: webmSrc, type: "video/webm" },
                { src: mp4Src, type: "video/mp4" },
            ];

            sources.forEach((s) => {
                if (s.src) {
                    const source = document.createElement("source");
                    source.src = s.src;
                    source.type = s.type;
                    video.appendChild(source);
                }
            });

            video.addEventListener(
                "canplay",
                () => {
                    video
                        .play()
                        .then(() => video.classList.add("is-playing"))
                        .catch((e) => console.error("Autoplay blocked", e));
                },
                { once: true },
            );

            video.load();
        };

        if ("requestIdleCallback" in window) {
            // @ts-ignore
            requestIdleCallback(initVideo);
        } else {
            setTimeout(initVideo, 200);
        }
    });
</script>

<style>
    /* ... (Your existing CSS remains unchanged) ... */
    #download-content {
        scroll-margin-top: 100px;
    }
    .hero-section {
        padding-top: 140px;
        padding-bottom: 80px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .hero-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 60px;
        align-items: center;
        width: 100%;
    }
    .badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 99px;
        background: var(--bg-sub);
        color: var(--primary);
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 24px;
        border: 1px solid var(--border);
    }
    .hero-title {
        font-size: var(--text-display);
        line-height: 1.1;
        margin-bottom: 24px;
    }
    .hero-sub {
        font-size: 1.2rem;
        color: var(--text-muted);
        margin-bottom: 40px;
        max-width: 500px;
    }
    .cta-wrapper {
        display: flex;
        justify-content: flex-start;
        width: 100%;
    }
    .text-gradient {
        background: linear-gradient(135deg, var(--primary), #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding-bottom: 0.2em;
        margin-bottom: -0.2em;
        display: inline-block;
        line-height: 1.2;
    }

    .phone-frame-wrapper {
        position: relative;
        width: 280px;
        margin: 0 auto;
        z-index: 2;
        aspect-ratio: 540 / 1174;
        background-color: #000;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 36px;
        border: 10px solid #1a1a1a;
        overflow: hidden;
    }

    .phone-frame-wrapper.skeleton-loader::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.03) 50%,
            rgba(255, 255, 255, 0) 100%
        );
        transform: translateX(-100%);
        animation: shimmer 2s infinite;
        z-index: 5;
        pointer-events: none;
    }

    @keyframes shimmer {
        100% {
            transform: translateX(100%);
        }
    }

    .app-video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 26px;
        opacity: 0;
        transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
    }

    .app-video.is-playing {
        opacity: 1;
    }

    /* Fix for Dark Mode Device Frame */
    :global([data-theme="dark"]) .phone-frame-wrapper {
        border-color: #333333;
        box-shadow:
            0 0 0 1px rgba(255, 255, 255, 0.1),
            0 20px 50px -10px rgba(0, 0, 0, 0.5);
    }

    .glow-blob {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 120%;
        height: 80%;
        background: var(--primary);
        filter: blur(80px);
        opacity: 0.2;
        z-index: -1;
    }

    @media (max-width: 768px) {
        .hero-section {
            padding-top: 32px;
            padding-bottom: 60px;
            min-height: 100dvh;
        }
        .hero-grid {
            grid-template-columns: 1fr;
            text-align: center;
            gap: 30px;
        }
        .cta-wrapper {
            justify-content: center;
        }
        .hero-content {
            order: 2;
        }
        .hero-visual {
            order: 1;
            margin-bottom: 10px;
        }
        .hero-sub {
            margin-left: auto;
            margin-right: auto;
        }
        .hero-title {
            font-size: 2.5rem;
        }
    }
</style>
