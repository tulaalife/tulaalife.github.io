---
// YogaPlans.astro â€” fixed: safe root lookup via id, guards, chevrons, autoplay pause on interaction
import CTAButton from "./CTAButton.astro";

export interface Item {
    href: string;
    title: string;
    subtitle?: string;
    image?: string;
    emojiFallback?: string;
}
export interface Props {
    title: string;
    subtitle?: string;
    items: Item[];
    ctaHref?: string;
    ctaLabel?: string;
    intervalMs?: number; // autoplay
    autoplay?: boolean;
}

const {
    title,
    subtitle,
    items = [],
    ctaHref = "/yoga",
    ctaLabel = "Explore yoga plans",
    intervalMs = 5200,
    autoplay = true,
} = Astro.props;

const defaultPreviewHref = items[0]?.href ?? "/";

// stable unique id for this instance
const cid = `yoga-plans-${globalThis.crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2)}`;
---

{
    items.length > 0 && (
        <section
            id={cid}
            class="yoga-plans"
            aria-labelledby="yoga-plans-title"
            role="region"
            data-interval={String(intervalMs)}
            data-autoplay={String(autoplay)}
        >
            <div class="ambient" aria-hidden="true" />

            <header class="yoga-header">
                <h2 id="yoga-plans-title" class="yoga-title">
                    {title}
                </h2>
                {subtitle && <p class="yoga-subtitle">{subtitle}</p>}
            </header>

            <div class="yoga-preview" id="yoga-preview">
                <a class="yoga-preview-card" href={defaultPreviewHref}>
                    <div class="progress" id="progress" />

                    {items[0]?.image ? (
                        <img
                            src={items[0].image}
                            alt={items[0].title}
                            decoding="async"
                            loading="eager"
                            class="yoga-preview-media"
                        />
                    ) : (
                        <div class="yoga-preview-emoji" aria-hidden="true">
                            {items[0]?.emojiFallback ?? "ðŸ§˜"}
                        </div>
                    )}

                    <div class="yoga-preview-info">
                        <h3 class="yoga-preview-title">{items[0]?.title}</h3>
                        {items[0]?.subtitle && (
                            <p class="yoga-preview-sub">{items[0]?.subtitle}</p>
                        )}
                    </div>
                </a>
            </div>

            {/* Carousel with overlaid chevrons */}
            <div class="scroll-wrap" aria-label="Yoga plans scroller">
                <ul
                    class="scroll-track"
                    id="scroll-track"
                    role="listbox"
                    aria-orientation="horizontal"
                    tabindex="0"
                >
                    {items.map((it, idx) => (
                        <li
                            class="scroll-item"
                            role="option"
                            aria-selected={idx === 0 ? "true" : "false"}
                            data-index={String(idx)}
                            data-href={it.href}
                            data-title={it.title}
                            data-sub={it.subtitle || ""}
                            data-img={it.image || ""}
                            data-emoji={it.emojiFallback || "ðŸ§˜"}
                        >
                            <div class="thumb">
                                {it.image ? (
                                    <img
                                        src={it.image}
                                        alt={it.title}
                                        loading="lazy"
                                        decoding="async"
                                    />
                                ) : (
                                    <div class="thumb-emoji" aria-hidden="true">
                                        {it.emojiFallback ?? "ðŸ§˜"}
                                    </div>
                                )}
                            </div>
                            <span class="thumb-title">{it.title}</span>
                        </li>
                    ))}
                </ul>

                {/* overlay chevrons */}
                <button
                    class="scroll-btn left"
                    aria-label="Scroll left"
                    type="button"
                >
                    â€¹
                </button>
                <button
                    class="scroll-btn right"
                    aria-label="Scroll right"
                    type="button"
                >
                    â€º
                </button>
            </div>

            <div class="cta-row">
                <CTAButton
                    href={ctaHref}
                    label={ctaLabel}
                    icon="â†—"
                    variant="soft"
                    size="lg"
                />
            </div>
        </section>
    )
}

<style>
    :root {
        --ambient-a: oklch(0.98 0.01 85);
        --ambient-b: oklch(0.96 0.02 60);
    }
    .yoga-plans {
        position: relative;
        max-width: 1180px;
        margin: 0 auto;
        padding: clamp(20px, 4vw, 40px) 16px;
        isolation: isolate;
    }
    .ambient {
        position: absolute;
        inset: 0;
        border-radius: 32px;
        margin: 0 8px;
        background: radial-gradient(
                60% 80% at 20% 0%,
                color-mix(in oklch, var(--ambient-a), transparent 30%) 0%,
                transparent 70%
            ),
            radial-gradient(
                60% 80% at 100% 40%,
                color-mix(in oklch, var(--ambient-b), transparent 30%) 0%,
                transparent 70%
            );
        opacity: 0.65;
        pointer-events: none;
        filter: blur(24px) saturate(1.02);
        z-index: -1;
    }
    .yoga-header {
        text-align: center;
        margin-bottom: clamp(16px, 2.6vw, 24px);
    }
    .yoga-title {
        margin: 0 0 clamp(6px, 1vw, 10px);
        font-size: clamp(24px, 3.2vw, 34px);
    }
    .yoga-subtitle {
        margin: 0;
        color: var(--muted);
        font-size: clamp(14px, 2vw, 18px);
    }

    .yoga-preview {
        margin: clamp(10px, 2vw, 20px) auto clamp(16px, 3vw, 30px);
        max-width: min(760px, 88vw);
    }
    .yoga-preview-card {
        position: relative;
        display: block;
        border-radius: 18px;
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        background: var(--card);
        border: 1px solid color-mix(in oklch, var(--ring), transparent 32%);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
        transition:
            transform 0.2s ease,
            box-shadow 0.2s ease,
            outline 0.2s ease;
    }
    .yoga-preview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 38px rgba(0, 0, 0, 0.12);
    }
    .yoga-preview-card:focus-visible {
        outline: 3px solid color-mix(in oklch, var(--accent), transparent 35%);
        outline-offset: 3px;
    }

    .yoga-preview-media,
    .yoga-preview-emoji {
        width: 100%;
        aspect-ratio: 16/10;
        display: block;
        object-fit: cover;
        background: color-mix(in oklch, var(--ring), transparent 85%);
    }
    .yoga-preview-emoji {
        display: grid;
        place-items: center;
        font-size: clamp(48px, 7vw, 64px);
    }
    .yoga-preview-info {
        padding: 12px 14px 14px;
        text-align: center;
    }
    .yoga-preview-title {
        margin: 0;
        font-size: clamp(18px, 2.2vw, 22px);
        line-height: 1.2;
    }
    .yoga-preview-sub {
        margin: 6px 0 0;
        font-size: clamp(13px, 2vw, 15px);
        color: var(--muted);
    }

    .progress {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 3px;
        background: color-mix(in oklch, var(--accent), white 12%);
        transform-origin: left center;
        transform: scaleX(0);
        opacity: 0.9;
    }

    .scroll-wrap {
        position: relative;
        margin: clamp(8px, 2.4vw, 20px) 0 clamp(14px, 3vw, 26px);
    }
    .scroll-track {
        position: relative;
        z-index: 1;
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        list-style: none;
        margin: 0;
        padding: 10px 32px;
        scroll-snap-type: x mandatory;
        mask-image: linear-gradient(
            90deg,
            transparent 0,
            black 32px,
            black calc(100% - 32px),
            transparent 100%
        );
    }
    .scroll-track:focus-visible {
        outline: 3px solid color-mix(in oklch, var(--accent), transparent 40%);
        outline-offset: 3px;
        border-radius: 8px;
    }
    .scroll-track::-webkit-scrollbar {
        display: none;
    }

    .scroll-item {
        flex: 0 0 auto;
        width: 148px;
        cursor: pointer;
        user-select: none;
        text-align: center;
        transition:
            transform 0.16s ease,
            box-shadow 0.16s ease,
            filter 0.16s ease;
        scroll-snap-align: center;
    }
    .scroll-item[aria-selected="true"] {
        transform: translateY(-2px) scale(1.03);
    }
    .scroll-item[aria-selected="true"] .thumb {
        border-color: color-mix(in oklch, var(--accent), transparent 45%);
        box-shadow:
            0 14px 26px rgba(0, 0, 0, 0.14),
            0 0 0 2px color-mix(in oklch, var(--accent), transparent 70%) inset;
    }
    .scroll-item[aria-selected="true"] .thumb-title {
        color: color-mix(in oklch, var(--accent), var(--fg) 65%);
        font-weight: 600;
    }

    .thumb {
        border-radius: 14px;
        overflow: hidden;
        background: color-mix(in oklch, var(--ring), transparent 82%);
        border: 1px solid color-mix(in oklch, var(--ring), transparent 35%);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
    }
    .thumb img,
    .thumb-emoji {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: cover;
        display: block;
    }
    .thumb-emoji {
        display: grid;
        place-items: center;
        font-size: 42px;
    }
    .thumb-title {
        display: block;
        margin-top: 6px;
        font-size: 0.92rem;
        line-height: 1.2;
    }

    .scroll-btn {
        position: absolute;
        z-index: 2;
        top: 50%;
        translate: 0 -50%;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: color-mix(in oklch, var(--card), white 8%);
        border: 1px solid color-mix(in oklch, var(--ring), transparent 30%);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
        color: var(--fg);
        font-size: 22px;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition:
            transform 0.18s ease,
            background 0.18s ease;
        pointer-events: auto;
    }
    .scroll-btn.left {
        left: 4px;
    }
    .scroll-btn.right {
        right: 4px;
    }
    .scroll-btn:hover {
        transform: translateY(-2px);
    }
    .scroll-btn:active {
        transform: translateY(0);
    }

    .cta-row {
        display: flex;
        justify-content: center;
        margin-top: 8px;
    }
    @media (min-width: 1200px) {
        .yoga-preview {
            max-width: 820px;
        }
    }
</style>

<script is:inline>
    (() => {
        const root = document.getElementById("{cid}");
        if (!root) return; // component not rendered

        const track = root.querySelector("#scroll-track");
        const preview = root.querySelector("#yoga-preview");
        if (!track || !preview) return;

        const previewLink = preview.querySelector(".yoga-preview-card");
        const titleEl = preview.querySelector(".yoga-preview-title");
        const subEl = preview.querySelector(".yoga-preview-sub");
        const progress = preview.querySelector("#progress");

        const leftBtn = root.querySelector(".scroll-btn.left");
        const rightBtn = root.querySelector(".scroll-btn.right");

        const intervalMs = Number(root.dataset.interval || 5200);
        const enableAutoplay = root.dataset.autoplay !== "false";

        let imgEl = preview.querySelector("img, .yoga-preview-emoji");
        let selected = null;
        let resumeTimer = null;
        let progressTimer = null;
        let userInteracted = false;

        const items = () => Array.from(track.querySelectorAll(".scroll-item"));

        function resolveItemFromEvent(evt) {
            const target = evt.target;
            if (!(target instanceof Node)) return null;
            let el =
                target.nodeType === Node.ELEMENT_NODE
                    ? target
                    : target.parentElement;
            while (
                el &&
                el !== track &&
                !(el instanceof Element && el.matches(".scroll-item"))
            ) {
                el = el.parentElement;
            }
            return el instanceof Element && el.matches(".scroll-item")
                ? el
                : null;
        }

        function setSelected(li) {
            if (!li) return;
            items().forEach((n) => n.setAttribute("aria-selected", "false"));
            li.setAttribute("aria-selected", "true");
            selected = li;

            // link
            if (previewLink)
                previewLink.href = li.dataset.href || previewLink.href;

            // media
            const nextImg = li.dataset.img;
            const nextEmoji = li.dataset.emoji || "ðŸ§˜";

            if (nextImg) {
                if (!(imgEl instanceof HTMLImageElement)) {
                    const newImg = new Image();
                    newImg.alt = li.dataset.title || "Yoga plan";
                    newImg.decoding = "async";
                    newImg.loading = "eager";
                    newImg.className = "yoga-preview-media";
                    imgEl?.replaceWith(newImg);
                    imgEl = newImg;
                }
                imgEl.src = nextImg;
            } else {
                if (
                    !(imgEl instanceof HTMLElement) ||
                    !imgEl.classList.contains("yoga-preview-emoji")
                ) {
                    const emojiDiv = document.createElement("div");
                    emojiDiv.className = "yoga-preview-emoji";
                    imgEl?.replaceWith(emojiDiv);
                    imgEl = emojiDiv;
                }
                imgEl.textContent = nextEmoji;
            }

            // text
            if (titleEl) titleEl.textContent = li.dataset.title || "";
            if (subEl) subEl.textContent = li.dataset.sub || "";

            // center the item
            li.scrollIntoView({
                behavior: "smooth",
                inline: "center",
                block: "nearest",
            });

            if (enableAutoplay && !userInteracted) startProgress();
        }

        function step(dir) {
            const list = items();
            if (!list.length) return;
            const idx = Math.max(0, list.indexOf(selected ?? list[0]));
            const next = list[(idx + dir + list.length) % list.length];
            setSelected(next);
        }

        function startProgress() {
            stopProgress();
            if (!progress) return;
            progress.style.transition = "none";
            progress.style.transform = "scaleX(0)";
            requestAnimationFrame(() => {
                progress.style.transition = `transform ${intervalMs}ms linear`;
                progress.style.transform = "scaleX(1)";
            });
            progressTimer = setTimeout(() => step(+1), intervalMs);
        }
        function stopProgress() {
            if (progressTimer) clearTimeout(progressTimer);
            progressTimer = null;
            if (progress) {
                progress.style.transition = "none";
                progress.style.transform = "scaleX(0)";
            }
        }
        function pauseAutoplay() {
            userInteracted = true;
            stopProgress();
            if (resumeTimer) clearTimeout(resumeTimer);
            resumeTimer = setTimeout(() => {
                userInteracted = false;
                if (enableAutoplay) startProgress();
            }, 6000);
        }

        // init
        setSelected(items()[0]);

        // interactions
        track.addEventListener("click", (e) => {
            const li = resolveItemFromEvent(e);
            if (!li) return;
            setSelected(li);
            pauseAutoplay();
        });

        track.addEventListener("keydown", (e) => {
            if (e.key === "ArrowRight" || e.key === "PageDown") {
                e.preventDefault();
                step(+1);
                pauseAutoplay();
            } else if (e.key === "ArrowLeft" || e.key === "PageUp") {
                e.preventDefault();
                step(-1);
                pauseAutoplay();
            }
        });

        const itemWidth = 148,
            gap = 12,
            scrollAmount = itemWidth + gap;
        leftBtn?.addEventListener("click", () => {
            track.scrollBy({ left: -scrollAmount, behavior: "smooth" });
            step(-1);
            pauseAutoplay();
        });
        rightBtn?.addEventListener("click", () => {
            track.scrollBy({ left: scrollAmount, behavior: "smooth" });
            step(+1);
            pauseAutoplay();
        });

        track.addEventListener("scroll", () => pauseAutoplay(), {
            passive: true,
        });

        const prefersReduced = window.matchMedia(
            "(prefers-reduced-motion: reduce)",
        ).matches;
        if (enableAutoplay && !prefersReduced) startProgress();
    })();
</script>
