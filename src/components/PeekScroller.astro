---
import CTAButton from "./CTAButton.astro";

export interface Item {
    href: string;
    title: string;
    subtitle?: string;
    image?: string;
    emojiFallback?: string;
}
export interface Props {
    title: string;
    subtitle?: string;
    items: Item[];
    ctaHref?: string;
    ctaLabel?: string;

    /** kept for API compatibility, unused in this version */
    intervalMs?: number;
    autoplay?: boolean;
}

const {
    title,
    subtitle,
    items = [],
    ctaHref = "/yoga",
    ctaLabel = "Explore yoga plans",
} = Astro.props;

// Use the first item's href, or a default fallback if the list is empty
const defaultPreviewHref = items[0]?.href ?? "/";
---

{
    items.length > 0 && (
        <section
            class="yoga-plans"
            aria-labelledby="yoga-plans-title"
            role="region"
        >
            {/* Header */}
            <header class="yoga-header">
                <h2 id="yoga-plans-title" class="yoga-title">
                    {title}
                </h2>
                {subtitle && <p class="yoga-subtitle">{subtitle}</p>}
            </header>

            {/* Preview */}
            <div class="yoga-preview" id="yoga-preview">
                <a class="yoga-preview-card" href={defaultPreviewHref}>
                    {items[0]?.image ? (
                        <img
                            src={items[0].image}
                            alt={items[0].title}
                            decoding="async"
                        />
                    ) : (
                        <div class="yoga-preview-emoji" aria-hidden="true">
                            {items[0]?.emojiFallback ?? "ðŸ§˜"}
                        </div>
                    )}
                    <div class="yoga-preview-info">
                        <h3 class="yoga-preview-title">{items[0]?.title}</h3>
                        {items[0]?.subtitle && (
                            <p class="yoga-preview-sub">{items[0]?.subtitle}</p>
                        )}
                    </div>
                </a>
            </div>

            {/* Horizontal scrollbar with chevrons */}
            <div class="scroll-wrap" aria-label="Yoga plans scroller">
                <button
                    class="scroll-btn left"
                    aria-label="Scroll left"
                    type="button"
                >
                    â€¹
                </button>

                <ul
                    class="scroll-track"
                    id="scroll-track"
                    role="listbox"
                    aria-orientation="horizontal"
                    tabindex="0"
                >
                    {items.map((it, idx) => (
                        <li
                            class="scroll-item"
                            role="option"
                            aria-selected={idx === 0 ? "true" : "false"}
                            data-href={it.href}
                            data-title={it.title}
                            data-sub={it.subtitle || ""}
                            data-img={it.image || ""}
                            data-emoji={it.emojiFallback || "ðŸ§˜"}
                        >
                            <div class="thumb">
                                {it.image ? (
                                    <img
                                        src={it.image}
                                        alt={it.title}
                                        loading="lazy"
                                        decoding="async"
                                    />
                                ) : (
                                    <div class="thumb-emoji" aria-hidden="true">
                                        {it.emojiFallback ?? "ðŸ§˜"}
                                    </div>
                                )}
                            </div>
                            <span class="thumb-title">{it.title}</span>
                        </li>
                    ))}
                </ul>

                <button
                    class="scroll-btn right"
                    aria-label="Scroll right"
                    type="button"
                >
                    â€º
                </button>
            </div>

            {/* CTA */}
            <div class="cta-row">
                <CTAButton
                    href={ctaHref}
                    label={ctaLabel}
                    icon="â†—"
                    variant="soft"
                    size="lg"
                />
            </div>
        </section>
    )
}
<style>
    .yoga-plans {
        max-width: 1120px;
        margin: 0 auto;
        padding: clamp(20px, 4vw, 38px) 16px;
    }

    .yoga-header {
        text-align: center;
        margin-bottom: clamp(16px, 2.6vw, 24px);
    }
    .yoga-title {
        margin: 0 0 clamp(6px, 1vw, 10px);
        font-size: clamp(24px, 3.2vw, 34px);
        letter-spacing: 0.2px;
    }
    .yoga-subtitle {
        margin: 0;
        color: var(--muted);
        font-size: clamp(14px, 2vw, 18px);
    }

    /* Preview */
    .yoga-preview {
        /* Adjusted vertical margin for a bit more space */
        margin: clamp(10px, 2vw, 20px) auto clamp(16px, 3vw, 30px);
        max-width: 680px;
    }
    .yoga-preview-card {
        display: block;
        border-radius: 18px;
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
        background: var(--card);
        border: 1px solid color-mix(in oklch, var(--ring), transparent 30%);
        transition:
            transform 0.18s ease,
            box-shadow 0.18s ease;
    }
    .yoga-preview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.12);
    }
    .yoga-preview-card img,
    .yoga-preview-emoji {
        width: 100%;
        aspect-ratio: 16/10;
        display: block;
        object-fit: cover;
        background: color-mix(in oklch, var(--ring), transparent 85%);
    }
    .yoga-preview-emoji {
        display: grid;
        place-items: center;
        font-size: 64px;
    }
    .yoga-preview-info {
        padding: 12px 14px 14px;
        text-align: center;
    }
    .yoga-preview-title {
        margin: 0;
        font-size: clamp(18px, 2.2vw, 22px);
        line-height: 1.2;
    }
    .yoga-preview-sub {
        margin: 6px 0 0;
        font-size: clamp(13px, 2vw, 15px);
        color: var(--muted);
    }

    /* Scroller */
    .scroll-wrap {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: clamp(8px, 2.4vw, 20px) 0 clamp(14px, 3vw, 26px);
    }
    .scroll-track {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        list-style: none;
        margin: 0;
        /* FIX: Added horizontal padding to center the first/last items */
        padding: 8px 16px 10px;
        flex: 1 1 auto;
        /* FIX: Enable scroll snapping */
        scroll-snap-type: x mandatory;
    }
    .scroll-track:focus-visible {
        outline: 3px solid color-mix(in oklch, var(--accent), transparent 40%);
        outline-offset: 3px;
        border-radius: 8px;
    }
    .scroll-track::-webkit-scrollbar {
        display: none;
    }

    .scroll-item {
        flex: 0 0 auto;
        /* FIX: Made scroll items smaller */
        width: 140px;
        cursor: pointer;
        user-select: none;
        text-align: center;
        transition:
            transform 0.16s ease,
            opacity 0.16s ease;
        /* FIX: Center the item when snapped */
        scroll-snap-align: center;
    }
    .scroll-item[aria-selected="true"] {
        transform: scale(1.02);
    }

    .thumb {
        border-radius: 12px;
        overflow: hidden;
        background: color-mix(in oklch, var(--ring), transparent 80%);
        border: 1px solid color-mix(in oklch, var(--ring), transparent 35%);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
    }
    .thumb img,
    .thumb-emoji {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: cover;
        display: block;
    }
    .thumb-emoji {
        display: grid;
        place-items: center;
        font-size: 42px;
    }
    .thumb-title {
        display: block;
        margin-top: 6px;
        font-size: 0.9rem; /* Slightly smaller font to match item size */
        line-height: 1.2;
    }

    /* Chevron buttons */
    .scroll-btn {
        background: linear-gradient(
            180deg,
            color-mix(in oklch, var(--card), white 6%),
            color-mix(in oklch, var(--card), transparent 8%)
        );
        border: 1px solid color-mix(in oklch, var(--ring), transparent 30%);
        color: var(--fg);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        font-size: 22px;
        line-height: 30px;
        display: grid;
        place-items: center;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        transition:
            background 0.18s ease,
            transform 0.18s ease;
        flex: 0 0 auto;
    }
    .scroll-btn:hover {
        transform: translateY(-1px);
    }
    .scroll-btn:active {
        transform: translateY(0);
    }

    .cta-row {
        display: flex;
        justify-content: center;
        margin-top: 8px;
    }
</style>

<script is:inline>
    // The script is fine, but I'll update the button scrolling slightly
    // to match the new item width for a better feel.
    (() => {
        const track = document.getElementById("scroll-track");
        const preview = document.getElementById("yoga-preview");
        if (!track || !preview) return;

        let previewLink = preview.querySelector(".yoga-preview-card");
        let imgEl = preview.querySelector("img, .yoga-preview-emoji");
        const titleEl = preview.querySelector(".yoga-preview-title");
        const subEl = preview.querySelector(".yoga-preview-sub");

        const updatePreview = (li) => {
            if (!li) return;

            // Update selection state
            track
                .querySelectorAll(".scroll-item[aria-selected='true']")
                .forEach((n) => n.setAttribute("aria-selected", "false"));
            li.setAttribute("aria-selected", "true");

            // Link
            previewLink.href = li.dataset.href || previewLink.href;

            // Media swap
            const nextImg = li.dataset.img;
            const nextEmoji = li.dataset.emoji || "ðŸ§˜";

            // Check if element is still in the DOM before using
            if (imgEl && imgEl.parentNode) {
                if (nextImg) {
                    if (!(imgEl instanceof HTMLImageElement)) {
                        const newImg = new Image();
                        newImg.alt = titleEl.textContent || "Yoga plan";
                        newImg.decoding = "async";
                        newImg.loading = "eager";
                        // Using class for styles instead of inline
                        newImg.className = "yoga-preview-media";
                        imgEl.replaceWith(newImg);
                        imgEl = newImg;
                    }
                    imgEl.src = nextImg;
                } else {
                    // switch to emoji block
                    if (imgEl.className !== "yoga-preview-emoji") {
                        const emojiDiv = document.createElement("div");
                        emojiDiv.className = "yoga-preview-emoji";
                        imgEl.replaceWith(emojiDiv);
                        imgEl = emojiDiv;
                    }
                    imgEl.textContent = nextEmoji;
                }
            }

            // Text
            titleEl.textContent = li.dataset.title || "";
            subEl.textContent = li.dataset.sub || "";
        };

        // Click to select
        track.addEventListener("click", (e) => {
            const li = e.target.closest(".scroll-item");
            if (li) updatePreview(li);
        });

        // Keyboard support (scroll-snap helps here, but we keep this for non-snapping browsers)
        track.addEventListener("keydown", (e) => {
            const current = track.querySelector(
                ".scroll-item[aria-selected='true']",
            );
            if (!current) return;
            if (e.key === "ArrowRight") {
                e.preventDefault();
                const next = current.nextElementSibling || current;
                next.scrollIntoView({ behavior: "smooth", inline: "center" });
                updatePreview(next);
            } else if (e.key === "ArrowLeft") {
                e.preventDefault();
                const prev = current.previousElementSibling || current;
                prev.scrollIntoView({ behavior: "smooth", inline: "center" });
                updatePreview(prev);
            }
        });

        // Chevron buttons
        const itemWidth = 140; // Matches the CSS scroll-item width
        const gap = 12; // Matches the CSS gap
        const scrollAmount = itemWidth + gap;

        const leftBtn = document.querySelector(".scroll-btn.left");
        const rightBtn = document.querySelector(".scroll-btn.right");

        // FIX: Scroll by one item width
        leftBtn?.addEventListener("click", () => {
            track.scrollBy({ left: -scrollAmount, behavior: "smooth" });
        });
        rightBtn?.addEventListener("click", () => {
            track.scrollBy({ left: scrollAmount, behavior: "smooth" });
        });
    })();
</script>
