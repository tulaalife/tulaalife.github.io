---
// PeekScroller.astro â€” Preview + Scroll list (rewrite, fixed)
// API kept same.

export interface Item {
  href: string;
  title: string;
  subtitle?: string;
  image?: string;
  emojiFallback?: string;
}
export interface Props {
  title: string;
  subtitle?: string;
  items: Item[];
  ctaHref?: string;
  ctaLabel?: string;
  intervalMs?: number;
}

const {
  title,
  subtitle,
  items = [],
  ctaHref,
  ctaLabel,
  intervalMs = 5200, // parity only
} = Astro.props;

const hasCTA = Boolean(ctaHref && ctaLabel);
const initial = items[0] ?? null;
---

{items.length > 0 && (
  <section
    class="peek"
    role="region"
    aria-labelledby={`peek-title-${title.replaceAll(' ', '-')}`}
    data-interval={String(intervalMs)}
  >
    <header class="peek__head">
      <div class="peek__titles">
        <h2 id={`peek-title-${title.replaceAll(' ', '-')}`} class="peek__title">{title}</h2>
        {subtitle && <p class="peek__subtitle">{subtitle}</p>}
      </div>

      {hasCTA && (
        <a href={ctaHref!} class="peek__cta btn btn--solid">{ctaLabel}</a>
      )}
    </header>

    {/* Preview window */}
    <a
      class="peek__preview"
      data-preview
      href={initial?.href}
      aria-label={`Open: ${initial?.title ?? ''}`}
    >
      <div class="peek__media" data-media>
        {initial?.image ? (
          <img src={initial.image} alt="" loading="lazy" />
        ) : (
          <div class="peek__emoji" data-emoji>{initial?.emojiFallback ?? "ðŸ§˜"}</div>
        )}
      </div>
      <div class="peek__meta">
        <div class="peek__meta-title" data-title>{initial?.title}</div>
        {initial?.subtitle && <div class="peek__meta-sub" data-subtitle>{initial?.subtitle}</div>}
      </div>
    </a>

    {/* Horizontal scroll list */}
    <div class="peek__rail-wrap">
      <ul class="peek__rail"
          role="listbox"
          aria-label={`${title} list`}
          data-rail>
        {items.map((it, idx) => (
          <li role="option" aria-selected={idx === 0 ? "true" : "false"}>
            <button
              type="button"
              class="peek__card"
              data-card
              data-index={String(idx)}
              data-href={it.href}
              data-title={it.title}
              data-subtitle={it.subtitle ?? ""}
              data-image={it.image ?? ""}
              data-emoji={it.emojiFallback ?? ""}
              aria-label={`Select: ${it.title}`}
            >
              <div class="peek__thumb">
                {it.image ? (
                  <img src={it.image} alt="" loading="lazy" />
                ) : (
                  <div class="peek__thumb-emoji">{it.emojiFallback ?? "ðŸ§©"}</div>
                )}
              </div>
              <div class="peek__card-title">{it.title}</div>
              {it.subtitle && <div class="peek__card-sub">{it.subtitle}</div>}
            </button>
          </li>
        ))}
      </ul>
    </div>

    <!-- Use classic script so document.currentScript works -->
    <script is:inline>
      (function () {
        const root = document.currentScript && document.currentScript.closest('.peek');
        if (!root) return; // guard if script moved/bundled
        const rail = root.querySelector('[data-rail]');
        const preview = root.querySelector('[data-preview]');
        const media = root.querySelector('[data-media]');
        const titleEl = root.querySelector('[data-title]');
        const subEl = root.querySelector('[data-subtitle]');

        function setSelected(cardBtn) {
          if (!cardBtn || !preview) return;

          // Update aria-selected on options
          rail?.querySelectorAll('li[role="option"]').forEach((opt) => {
            opt.setAttribute('aria-selected', opt.contains(cardBtn) ? 'true' : 'false');
          });

          const href = cardBtn.dataset.href || '#';
          const title = cardBtn.dataset.title || '';
          const sub = cardBtn.dataset.subtitle || '';
          const img = cardBtn.dataset.image || '';
          const emo = cardBtn.dataset.emoji || '';

          // Update link target
          preview.setAttribute('href', href);
          preview.setAttribute('aria-label', `Open: ${title}`);

          // Swap media (img or emoji)
          media.innerHTML = '';
          if (img) {
            const im = new Image();
            im.loading = 'lazy';
            im.alt = '';
            im.src = img;
            media.appendChild(im);
          } else {
            const div = document.createElement('div');
            div.className = 'peek__emoji';
            div.textContent = emo || 'ðŸ§˜';
            media.appendChild(div);
          }

          // Update text
          if (titleEl) titleEl.textContent = title;
          if (subEl) {
            subEl.textContent = sub;
            subEl.style.display = sub ? '' : 'none';
          }
        }

        // Click selection
        rail?.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-card]');
          if (btn) setSelected(btn);
        });

        // Focus selection (helps keyboard & screen readers)
        rail?.addEventListener('focusin', (e) => {
          const btn = e.target.closest && e.target.closest('[data-card]');
          if (btn) setSelected(btn);
        });

        // Keyboard nav (Left/Right + Enter/Space)
        rail?.addEventListener('keydown', (e) => {
          const cards = Array.from(rail.querySelectorAll('[data-card]'));
          // Find selected <li>, then its button
          const selectedLi = rail.querySelector('li[role="option"][aria-selected="true"]');
          const activeIdx = Math.max(0, cards.findIndex((c) => c.closest('li') === selectedLi));

          if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            e.preventDefault();
            const delta = e.key === 'ArrowRight' ? 1 : -1;
            const next = cards[(activeIdx + delta + cards.length) % cards.length];
            next?.focus();
            setSelected(next);
            next?.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
          } else if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const btn = cards[activeIdx] || cards[0];
            if (btn) setSelected(btn);
          }
        });

        // Initial selection sync (in case SSR changed)
        const first = rail?.querySelector('[data-card]');
        if (first) setSelected(first);
      })();
    </script>
  </section>
)}

<style>
  .peek {
    width: 100%;
    margin: 0;
    display: grid;
    gap: clamp(12px, 1.8vw, 18px);
  }

  .peek__head {
    display: flex;
    align-items: end;
    justify-content: space-between;
    gap: 12px;
  }

  .peek__titles { display: grid; gap: 4px; }

  .peek__title {
    font-size: clamp(18px, 2.6vw, 24px);
    font-weight: 750;
    margin: 0;
  }

  .peek__subtitle {
    margin: 0;
    opacity: 0.8;
    font-size: clamp(13px, 1.8vw, 15px);
  }

  .peek__cta { white-space: nowrap; }

  /* Preview card */
  .peek__preview {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: auto auto;
    gap: 10px;
    text-decoration: none;
    background: color-mix(in oklab, var(--card) 80%, transparent);
    border: 1px solid color-mix(in oklab, var(--ring) 60%, transparent);
    border-radius: 16px;
    padding: clamp(10px, 1.8vw, 14px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .peek__media {
    position: relative;
    aspect-ratio: 16 / 9;
    border-radius: 12px;
    overflow: hidden;
    background: color-mix(in oklab, var(--bg) 92%, transparent);
  }
  .peek__media img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .peek__emoji {
    width: 100%; height: 100%;
    display: grid; place-items: center;
    font-size: clamp(48px, 8vw, 80px);
  }

  .peek__meta { display: grid; gap: 4px; }
  .peek__meta-title { font-weight: 700; font-size: clamp(16px, 2.2vw, 18px); color: var(--text); }
  .peek__meta-sub { font-size: clamp(13px, 1.8vw, 14px); opacity: .8; }

  /* Rail (scroll list) */
  .peek__rail-wrap { overflow: hidden; }
  .peek__rail {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: min(56%, 320px);
    gap: clamp(10px, 1.6vw, 14px);
    overflow-x: auto;
    padding: 2px;
    margin: 0;
    list-style: none;
    scroll-snap-type: x proximity;
  }
  .peek__rail li { scroll-snap-align: center; }

  .peek__card {
    display: grid;
    gap: 8px;
    width: 100%;
    text-align: left;
    background: color-mix(in oklab, var(--card) 80%, transparent);
    border: 1px solid color-mix(in oklab, var(--ring) 60%, transparent);
    border-radius: 12px;
    padding: 10px;
    cursor: pointer;
    transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
  }
  .peek__card:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }
  [role="option"][aria-selected="true"] .peek__card {
    border-color: var(--accent);
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    transform: translateY(-1px);
  }

  .peek__thumb {
    position: relative;
    aspect-ratio: 4 / 3;
    border-radius: 10px;
    overflow: hidden;
    background: color-mix(in oklab, var(--bg) 92%, transparent);
  }
  .peek__thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .peek__thumb-emoji {
    width: 100%; height: 100%;
    display: grid; place-items: center;
    font-size: clamp(36px, 6vw, 64px);
  }

  .peek__card-title { font-weight: 650; font-size: 14.5px; }
  .peek__card-sub { font-size: 13px; opacity: .8; line-height: 1.25; }

  @media (prefers-reduced-motion: reduce) { .peek__card { transition: none; } }
</style>