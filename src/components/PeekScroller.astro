---
import CTAButton from "./CTAButton.astro";

export interface Item {
  href: string;
  title: string;
  subtitle?: string;
  image?: string;
  emojiFallback?: string;
}
export interface Props {
  title: string;
  subtitle?: string;
  items: Item[];
  ctaHref?: string;
  ctaLabel?: string;
  intervalMs?: number;
}

const {
  title,
  subtitle,
  items = [],
  ctaHref,
  ctaLabel,
  intervalMs = 5200,
} = Astro.props;

const hasCTA = Boolean(ctaHref && ctaLabel);
const initial = items[0] ?? null;
---

{items.length > 0 && (
  <section class="peek" role="region" aria-labelledby={`peek-title-${title.replaceAll(' ', '-')}`}>
    <header class="peek__head">
      <h2 id={`peek-title-${title.replaceAll(' ', '-')}`} class="peek__title">{title}</h2>
      {subtitle && <p class="peek__subtitle">{subtitle}</p>}
    </header>

    {/* Preview card */}
    <a class="peek__preview" data-preview href={initial?.href} aria-label={`Open: ${initial?.title ?? ''}`}>
      <div class="peek__media" data-media>
        {initial?.image ? (
          <img src={initial.image} alt="" loading="lazy" />
        ) : (
          <div class="peek__emoji" data-emoji>{initial?.emojiFallback ?? "ðŸ§˜"}</div>
        )}
      </div>
      <div class="peek__meta">
        <div class="peek__meta-title" data-title>{initial?.title}</div>
        {initial?.subtitle && <div class="peek__meta-sub" data-subtitle>{initial?.subtitle}</div>}
      </div>
    </a>

    {/* Carousel */}
    <div class="peek__rail-wrap">
      <ul class="peek__rail" data-rail>
        {items.map((it, idx) => (
          <li role="option" aria-selected={idx === 0 ? "true" : "false"}>
            <button
              type="button"
              class="peek__card"
              data-card
              data-index={String(idx)}
              data-href={it.href}
              data-title={it.title}
              data-subtitle={it.subtitle ?? ""}
              data-image={it.image ?? ""}
              data-emoji={it.emojiFallback ?? ""}
            >
              <div class="peek__thumb">
                {it.image ? <img src={it.image} alt="" loading="lazy" /> : <div class="peek__thumb-emoji">{it.emojiFallback ?? "ðŸ§©"}</div>}
              </div>
              <div class="peek__card-title">{it.title}</div>
              {it.subtitle && <div class="peek__card-sub">{it.subtitle}</div>}
            </button>
          </li>
        ))}
      </ul>
    </div>

    {/* CTA below carousel */}
    {hasCTA && (
      <div class="peek__cta-wrap">
        <CTAButton href={ctaHref!} label={ctaLabel!} variant="solid" size="lg" />
      </div>
    )}

    <script is:inline>
      (function () {
        const root = document.currentScript?.closest('.peek');
        if (!root) return;
        const rail = root.querySelector('[data-rail]');
        const preview = root.querySelector('[data-preview]');
        const media = root.querySelector('[data-media]');
        const titleEl = root.querySelector('[data-title]');
        const subEl = root.querySelector('[data-subtitle]');

        function applyOrientation(imgUrl) {
          // Clear, then insert <img> so we can read natural sizes
          media.innerHTML = '';
          const im = new Image();
          im.loading = 'lazy';
          im.alt = '';
          im.src = imgUrl;
          im.onload = () => {
            const isPortrait = im.naturalHeight > im.naturalWidth;
            media.classList.toggle('is-portrait', isPortrait);
            media.classList.toggle('is-landscape', !isPortrait);
            // blurred backdrop for polish
            media.style.setProperty('--bg-url', `url("${imgUrl}")`);
          };
          media.appendChild(im);
        }

        function setSelected(cardBtn) {
          if (!cardBtn || !preview) return;

          rail?.querySelectorAll('li[role="option"]').forEach((opt) =>
            opt.setAttribute('aria-selected', opt.contains(cardBtn) ? 'true' : 'false')
          );

          const href = cardBtn.dataset.href || '#';
          const title = cardBtn.dataset.title || '';
          const sub = cardBtn.dataset.subtitle || '';
          const img = cardBtn.dataset.image || '';
          const emo = cardBtn.dataset.emoji || '';

          preview.href = href;

          if (img) {
            applyOrientation(img);
          } else {
            media.innerHTML = `<div class="peek__emoji">${emo || "ðŸ§˜"}</div>`;
            media.classList.remove('is-portrait', 'is-landscape');
            media.style.removeProperty('--bg-url');
          }

          if (titleEl) titleEl.textContent = title;
          if (subEl) {
            subEl.textContent = sub || "";
            subEl.style.display = sub ? "" : "none";
          }
        }

        rail?.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-card]');
          if (btn) setSelected(btn);
        });

        // Initial
        const first = rail?.querySelector('[data-card]');
        if (first) setSelected(first);
      })();
    </script>
  </section>
)}
<style>
  /* Premium, adaptive preview */
.peek { width: 100%; display: grid; gap: clamp(16px, 2vw, 24px); justify-items: center; }
.peek__head { text-align: center; }
.peek__title { font-size: clamp(20px, 3vw, 26px); font-weight: 750; margin: 0; }
.peek__subtitle { margin: 4px 0 0; opacity: .8; font-size: clamp(14px, 1.6vw, 16px); }

.peek__preview {
  width: min(100%, 960px);
  display: grid;
  gap: 10px;
  text-decoration: none;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 28px rgba(0,0,0,.1);
  background: var(--card);
}

.peek__media {
  position: relative;
  /* default to landscape */
  aspect-ratio: 16 / 9;
  overflow: hidden;
  isolation: isolate;
}
.peek__media.is-portrait { aspect-ratio: 3 / 4; }  /* portrait preview height */
.peek__media.is-landscape { aspect-ratio: 16 / 9; }

.peek__media::before {
  content: "";
  position: absolute; inset: 0;
  background-image: var(--bg-url, none);
  background-size: cover;
  background-position: center;
  transform: scale(1.12);
  z-index: 0;
}
.peek__media > img, .peek__emoji { 
  position: relative; z-index: 1;
  width: 100%; height: 100%; object-fit: cover; /* center-crop inside the chosen aspect */
  display: block;
}
.peek__emoji { display: grid; place-items: center; font-size: clamp(48px, 8vw, 80px); }

.peek__meta { text-align: center; padding: 8px 16px 14px; }
.peek__meta-title { font-weight: 700; font-size: clamp(16px, 2vw, 18px); color: var(--accent); }
.peek__meta-sub { font-size: 14px; opacity: .85; }

/* Carousel */
.peek__rail-wrap { width: min(100%, 960px); overflow-x: auto; }
.peek__rail {
  display: grid; grid-auto-flow: column; grid-auto-columns: min(56%, 320px);
  gap: 14px; padding: 4px 2px; margin: 0; list-style: none; scroll-snap-type: x proximity;
}
.peek__rail li { scroll-snap-align: center; }

.peek__card {
  background: color-mix(in oklab, var(--card) 80%, transparent);
  border-radius: 14px; border: 1px solid color-mix(in oklab, var(--ring) 70%, transparent);
  display: grid; gap: 8px; text-align: center; cursor: pointer;
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,.05);
}
.peek__card:hover { transform: translateY(-2px); border-color: var(--accent); box-shadow: 0 6px 18px rgba(0,0,0,.08); }

.peek__thumb { aspect-ratio: 4 / 3; border-radius: 12px; overflow: hidden; }
.peek__thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform .25s ease; }
.peek__card:hover .peek__thumb img { transform: scale(1.04); }

.peek__card-title { font-weight: 650; font-size: 14.5px; color: var(--accent); }
.peek__card-sub { font-size: 13px; opacity: .8; line-height: 1.3; margin-bottom: 10px; }

.peek__cta-wrap { margin-top: clamp(12px, 2vw, 20px); }
</style>