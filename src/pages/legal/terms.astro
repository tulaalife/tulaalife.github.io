---
import Site from "../../layouts/Site.astro";
import { marked } from "marked"; // Run 'npm install marked' if missing

const title = "Tulaa — Terms of Use";
const description =
    "Tulaa Terms of Use — privacy-first, optional anonymous analytics and crash reporting, no ads.";

// 1. Fetch content from the Single Source of Truth (R2)
let contentHtml = "";

try {
    const res = await fetch("https://legal.tulaalife.com/terms_en.md");
    if (res.ok) {
        let rawMarkdown = await res.text();

        // Optional: Remove the first line (Title) from markdown
        // because we render a custom H1 with the Logo below.
        rawMarkdown = rawMarkdown.replace(/^# .+\n/, "");

        // Parse Markdown to HTML
        contentHtml = await marked.parse(rawMarkdown);
    } else {
        throw new Error(`Remote fetch failed: ${res.status}`);
    }
} catch (e) {
    console.error("Legal doc fetch error:", e);
    // Fallback content in case R2 is down
    contentHtml = `
    <div class="legal-box" style="border-color: red">
      <p><strong>Offline Mode:</strong> Unable to load the latest terms from server.</p>
    </div>
    <p>Please contact <a href="mailto:contact@tulaalife.com">contact@tulaalife.com</a> for the latest version.</p>
  `;
}
---

<Site
    title={title}
    description={description}
    canonicalPath="/legal/terms"
    hideFooter={true}
>
    <main class="legal-wrap">
        <!-- Custom Header with Logo -->
        <h1 class="legal-title">
            <img
                src="https://images.tulaa.life/logo.webp"
                alt="Tulaa logo"
                width="48"
                height="48"
                class="legal-logo"
            />
            Tulaa — Terms of Use
        </h1>

        <!-- Content from R2 -->
        <!-- We use 'set:html' to inject the parsed Markdown -->
        <div class="markdown-body" set:html={contentHtml} />

        <p class="legal-meta">
            Need help? <a href="mailto:contact@tulaalife.com"
                >contact@tulaalife.com</a
            >
            · <a href="/legal/privacy">Privacy Policy</a>
        </p>

        <script type="application/ld+json" is:inline>
            {
                "@context": "https://schema.org",
                "@type": "WebPage",
                "name": "Tulaa — Terms of Use",
                "url": "https://tulaalife.com/legal/terms",
                "inLanguage": "en",
                "datePublished": "2025-09-16"
            }
        </script>
    </main>
</Site>

<style is:global>
    /* Use is:global to style the injected HTML content */

    .legal-wrap {
        max-width: 940px;
        margin: 0 auto;
        padding: 24px;
        font-family: var(--font-sans);
    }

    .legal-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 12px 0 24px;
        font-size: 1.9rem;
        font-weight: 750;
    }

    .legal-logo {
        vertical-align: middle;
        border-radius: 8px;
    }

    .legal-meta {
        color: var(--muted);
        font-size: 0.9rem;
        margin: 28px 0 18px;
        border-top: 1px solid var(--ring);
        padding-top: 20px;
    }

    /* --- Markdown Styles --- */

    .markdown-body h2 {
        margin-top: 28px;
        margin-bottom: 12px;
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--foreground);
    }

    .markdown-body p,
    .markdown-body ul,
    .markdown-body li {
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 12px;
        color: var(--foreground);
    }

    .markdown-body ul {
        padding-left: 24px;
    }

    .markdown-body li {
        margin-bottom: 6px;
    }

    .markdown-body strong {
        font-weight: 600;
    }

    /* Convert Markdown Blockquotes (>) into your "Legal Box" style */
    .markdown-body blockquote {
        background: var(--card);
        border: 1px solid var(--ring);
        padding: 16px 18px;
        border-radius: 14px;
        margin: 18px 0;
        /* Reset default blockquote margins */
        margin-inline-start: 0;
        margin-inline-end: 0;
    }

    .markdown-body blockquote p {
        margin-bottom: 0; /* Remove bottom margin inside box */
    }

    .markdown-body a {
        color: var(--primary);
        text-decoration: underline;
        text-underline-offset: 4px;
    }
</style>
